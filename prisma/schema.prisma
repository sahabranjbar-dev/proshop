generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String     @id @default(cuid())
  email         String?    @unique
  phone         String?    @unique
  firstName     String?
  lastName      String?
  password      String?
  avatar        String?
  emailVerified DateTime?
  isActive      Boolean    @default(true)
  role          Role       @default(USER)

  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  deletedAt     DateTime?

  orders        Order[]
  addresses     Address[]
  reviews       Review[]
  cart          Cart?

  @@index([email, phone])
}

model Address {
  id         String    @id @default(cuid())
  title      String    @default("Home")
  postalCode String
  city       String
  address    String    @db.Text
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  orders     Order[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

}

enum Role {
  ADMIN
  USER
  EDITOR
}

model Product {
  id            String          @id @default(cuid())
  title         String
  slug          String          @unique
  description   String?         @db.Text
  content       String?         @db.Text
  price         Decimal         @db.Decimal(10, 2)
  comparePrice  Decimal?        @db.Decimal(10, 2)

  stock         Int             @default(0)
  sku           String?         @unique
  isPublished   Boolean         @default(true)

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?

  campaigns     SaleCampaign[]  @relation("CampaignProducts")
  files         File[]          @relation("ProductFiles")
  categories    Category[]      @relation("ProductCategories")
  orderItems    OrderItem[]
  reviews       Review[]
  cartItems     CartItem[]      // Added for relation fix

  @@index([slug, isPublished])
}

model Category {
  id          String          @id @default(cuid())
  name        String
  slug        String          @unique
  description String?

  parentId    String?
  parent      Category?       @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[]      @relation("CategoryHierarchy")
  products    Product[]       @relation("ProductCategories")
  campaigns   SaleCampaign[]  @relation("CampaignCategories")

  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

}

model Review {
  id        String    @id @default(cuid())
  rating    Int       @default(5)
  comment   String?   @db.Text

  userId    String
  user      User      @relation(fields: [userId], references: [id])

  productId String
  product   Product   @relation(fields: [productId], references: [id])

  createdAt DateTime  @default(now())

}

model Order {
  id             String        @id @default(cuid())
  orderNumber    String        @unique @default(cuid())
  status         OrderStatus   @default(PENDING)
  totalAmount    Decimal       @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @db.Decimal(10, 2)

  couponId       String?
  coupon         Coupon?       @relation(fields: [couponId], references: [id])

  userId         String
  user           User          @relation(fields: [userId], references: [id])

  addressId      String?
  address        Address?      @relation(fields: [addressId], references: [id])

  orderItems     OrderItem[]
  payment        Payment?

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

}

model OrderItem {
  id        String    @id @default(cuid())
  orderId   String
  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   Product?  @relation(fields: [productId], references: [id])

  quantity  Int
  price     Decimal    @db.Decimal(10, 2)

}

model Payment {
  id         String         @id @default(cuid())
  amount     Decimal        @db.Decimal(10, 2)
  method     PaymentMethod  @default(ONLINE)
  status     PaymentStatus  @default(PENDING)
  authority  String?
  refId      String?

  orderId    String         @unique
  order      Order          @relation(fields: [orderId], references: [id])

  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

}

model OtpCode {
  phone      String     @id
  code       String
  expiresAt  DateTime
  createdAt  DateTime   @default(now())

}

model File {
  id         String     @id @default(cuid())
  key        String     @unique
  url        String
  name       String?
  size       Int?
  type       String?

  productId  String?
  product    Product?   @relation("ProductFiles", fields: [productId], references: [id], onDelete: SetNull)

  createdAt  DateTime   @default(now())

}

model Coupon {
  id             String        @id @default(cuid())
  code           String        @unique
  type           DiscountType
  value          Decimal       @db.Decimal(10, 2)

  startDate      DateTime?
  endDate        DateTime?

  usageLimit     Int?
  usedCount      Int           @default(0)

  minOrderAmount Decimal?      @db.Decimal(10, 2)

  isActive       Boolean       @default(true)

  orders         Order[]

  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

}

model SaleCampaign {
  id          String         @id @default(cuid())
  title       String
  description String?
  bannerUrl   String?

  type        DiscountType
  value       Decimal        @db.Decimal(10, 2)

  startDate   DateTime
  endDate     DateTime

  isActive    Boolean        @default(true)

  products    Product[]      @relation("CampaignProducts")
  categories  Category[]     @relation("CampaignCategories")

  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

}

model Cart {
  id        String      @id @default(cuid())
  userId    String      @unique
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

}

model CartItem {
  id        String     @id @default(cuid())

  cartId    String
  cart      Cart       @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   Product    @relation(fields: [productId], references: [id])

  quantity  Int        @default(1)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([cartId, productId])
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  ONLINE
  CASH_ON_DELIVERY
  WALLET
}

enum DiscountType {
  PERCENTAGE
  FIXED
}
